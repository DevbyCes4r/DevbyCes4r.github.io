---
import BaseLayout from "./BaseLayout.astro";
import AIOptimizedContent from "../components/AIOptimizedContent.astro";
import FAQSection from "../components/FAQSection.astro";
import type { CollectionEntry } from "astro:content";

interface Props {
  post: CollectionEntry<"blog">;
}

const { post } = Astro.props;
const {
  title,
  description,
  publishDate,
  updatedDate,
  image,
  imageAlt,
  author,
  readingTime,
  categories,
  tags,
  contentType = "guide",
  difficulty = "beginner",
  prerequisites,
  learningOutcomes,
  faqs,
} = post.data;

// Convert author name to URL slug
const authorSlug = author
  .toLowerCase()
  .normalize("NFD")
  .replace(/[\u0300-\u036f]/g, "") // Remove accents
  .replace(/\s+/g, "-"); // Replace spaces with hyphens

const authorUrl = new URL(`/autor/${authorSlug}`, Astro.site).toString();

const articleSchema = {
  "@context": "https://schema.org",
  "@type": "Article",
  headline: title,
  description: description,
  image: new URL(image || "/og-default.jpg", Astro.site),
  datePublished: publishDate.toISOString(),
  dateModified: (updatedDate || publishDate).toISOString(),
  author: {
    "@type": "Person",
    name: author,
    url: authorUrl,
  },
  mainEntityOfPage: {
    "@type": "WebPage",
    "@id": new URL(Astro.url.pathname, Astro.site),
  },
};
---

<BaseLayout
  title={title}
  description={description}
  image={image}
  article={true}
>
  <script
    type="application/ld+json"
    set:html={JSON.stringify(articleSchema)}
    slot="head"
  />

  <article class="prose dark:prose-invert prose-lg max-w-none">
    <header
      class="mb-12 not-prose border-b border-slate-200 dark:border-slate-800 pb-12"
    >
      <div class="flex gap-2 mb-6">
        {
          categories.map((cat: string) => (
            <span class="px-3 py-1 bg-blue-100 dark:bg-blue-500/20 text-blue-700 dark:text-blue-300 rounded-full text-sm font-medium">
              {cat}
            </span>
          ))
        }
      </div>

      <h1
        class="text-4xl md:text-5xl font-bold mb-8 bg-clip-text text-transparent bg-gradient-to-r from-blue-600 via-purple-600 to-pink-600 dark:from-blue-100 dark:to-white"
      >
        {title}
      </h1>

      <div
        class="flex flex-col md:flex-row md:items-center justify-between gap-6"
      >
        <div class="flex items-center gap-4">
          <img
            src="/images/profile-cesar.webp"
            alt={`Foto de ${author}`}
            width="48"
            height="48"
            class="w-12 h-12 rounded-full object-cover shadow-md ring-2 ring-slate-200 dark:ring-slate-700"
          />
          <div>
            <a
              href={`/autor/${authorSlug}`}
              class="font-bold text-slate-900 dark:text-white hover:text-blue-600 dark:hover:text-blue-400 transition-colors"
            >
              {author}
            </a>
            <p class="text-sm text-slate-500 dark:text-slate-400">Autor</p>
          </div>
        </div>

        <div class="flex gap-6 text-sm text-slate-600 dark:text-slate-400">
          <div class="flex flex-col">
            <span class="font-semibold text-slate-900 dark:text-slate-200"
              >Publicado</span
            >
            <time datetime={publishDate.toISOString()}>
              {publishDate.toLocaleDateString("es-ES", { dateStyle: "long" })}
            </time>
          </div>
          <div class="w-px bg-slate-200 dark:bg-slate-700"></div>
          <div class="flex flex-col">
            <span class="font-semibold text-slate-900 dark:text-slate-200"
              >Lectura</span
            >
            <span>{readingTime}</span>
          </div>
        </div>
      </div>
    </header>

    {
      image && (
        <div class="mb-12 rounded-2xl overflow-hidden shadow-2xl border border-slate-200 dark:border-slate-800">
          <img 
            src={image} 
            alt={imageAlt || title} 
            class="w-full h-auto object-cover"
            loading="eager"
            fetchpriority="high"
          />
        </div>
      )
    }

    <div
      class="bg-blue-50 dark:bg-slate-800/50 p-8 rounded-2xl border border-blue-100 dark:border-slate-700 mb-12 not-prose shadow-sm"
    >
      <h3
        class="text-lg font-bold mb-3 text-slate-900 dark:text-white flex items-center gap-2"
      >
        <span class="text-2xl">ðŸ’¡</span> Resumen
      </h3>
      <p class="text-slate-700 dark:text-slate-300 leading-relaxed text-lg">
        {description}
      </p>
    </div>

    <div class="ai-content-wrapper">
      <AIOptimizedContent
        type={contentType}
        title={title}
        difficulty={difficulty}
        timeToRead={readingTime}
        prerequisites={prerequisites}
        learningOutcomes={learningOutcomes}
      >
        <slot />
      </AIOptimizedContent>
      {
        faqs && faqs.length > 0 && (
          <FAQSection faqs={faqs} className="mt-8" />
        )
      }

      <footer
        class="mt-12 pt-8 border-t border-slate-200 dark:border-slate-800 not-prose"
      >
        <div class="flex flex-wrap gap-2">
          {
            tags.map((tag: string) => (
              <a
                href={`/tags/${tag}`}
                class="text-sm text-slate-600 dark:text-slate-400 hover:text-blue-600 dark:hover:text-blue-400 transition-colors"
              >
                #{tag}
              </a>
            ))
          }
        </div>
      </footer>
    </div>
  </article>

  <div
    id="progress-container"
    class="fixed top-0 left-0 w-full h-1 z-[100] bg-transparent pointer-events-none"
  >
    <div
      id="progress-bar"
      class="h-full w-0 bg-gradient-to-r from-blue-600 via-purple-600 to-pink-600 dark:from-blue-400 dark:via-purple-500 dark:to-pink-500 transition-all duration-150 ease-out"
    >
    </div>
  </div>

  <script>
    import { trackBlogComplete, waitForGoatCounter } from '../utils/analytics';

    // Solo trackear lectura completa (100%) - el dato mÃ¡s valioso
    const blogSlug = window.location.pathname.split('/').filter(Boolean).pop() || '';
    let tracked = false;
    let ticking = false;
    
    // Cache de valores para evitar reflow
    let articleTop = 0;
    let articleHeight = 0;

    function updateArticleMetrics() {
      const article = document.querySelector('article');
      if (article) {
        articleTop = article.offsetTop;
        articleHeight = article.offsetHeight;
      }
    }

    function checkComplete() {
      if (tracked) return;

      const scrollPercentage = Math.round(
        ((window.scrollY + window.innerHeight - articleTop) / articleHeight) * 100
      );

      if (scrollPercentage >= 95) {
        tracked = true;
        waitForGoatCounter(() => trackBlogComplete(blogSlug));
      }
      
      ticking = false;
    }

    function onScroll() {
      if (!ticking) {
        requestAnimationFrame(checkComplete);
        ticking = true;
      }
    }

    // Inicializar mÃ©tricas despuÃ©s de que el DOM estÃ© listo
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', updateArticleMetrics);
    } else {
      updateArticleMetrics();
    }

    window.addEventListener('scroll', onScroll, { passive: true });

    // Abrir enlaces en nueva pestaÃ±a
    document.addEventListener('DOMContentLoaded', () => {
      const contentWrapper = document.querySelector('.ai-content-wrapper');
      if (contentWrapper) {
        contentWrapper.querySelectorAll('a').forEach((link) => {
          const href = link.getAttribute('href');
          if (href && !href.startsWith('#')) {
            link.setAttribute('target', '_blank');
            link.setAttribute('rel', 'noopener noreferrer');
          }
        });
      }
    });
  </script>

  <script>
    const progressBar = document.getElementById("progress-bar");

    function updateProgress() {
      const scrollTop =
        window.pageYOffset || document.documentElement.scrollTop;
      const scrollHeight =
        document.documentElement.scrollHeight -
        document.documentElement.clientHeight;
      const scrollPercentage = (scrollTop / scrollHeight) * 100;

      if (progressBar) {
        progressBar.style.width = `${scrollPercentage}%`;
      }
    }

    window.addEventListener("scroll", updateProgress);
    window.addEventListener("resize", updateProgress);

    // Open all blog content links in new tab
    document.addEventListener("DOMContentLoaded", () => {
      const contentWrapper = document.querySelector(".ai-content-wrapper");
      if (contentWrapper) {
        const links = contentWrapper.querySelectorAll("a");
        links.forEach((link) => {
          const href = link.getAttribute("href");
          // If it's not an internal anchor link
          if (href && !href.startsWith("#")) {
            link.setAttribute("target", "_blank");
            link.setAttribute("rel", "noopener noreferrer");
          }
        });
      }
    });
  </script>
</BaseLayout>
