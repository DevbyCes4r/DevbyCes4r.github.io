---
interface Props {
    email?: string;
}

const { email = "68ab8f53477033d51322c3528d3f5030" } = Astro.props;
---

<div id="form-container" class="max-w-2xl mx-auto">
    <div
        id="success-message"
        class="hidden bg-white dark:bg-slate-800 rounded-2xl p-8 border border-green-200 dark:border-green-900 shadow-lg text-center"
    >
        <div
            class="w-16 h-16 bg-green-100 dark:bg-green-900/30 rounded-full flex items-center justify-center mx-auto mb-4"
        >
            <svg
                class="w-8 h-8 text-green-500"
                fill="none"
                stroke="currentColor"
                viewBox="0 0 24 24"
            >
                <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"
                    d="M5 13l4 4L19 7"></path>
            </svg>
        </div>
        <h3 class="text-2xl font-bold text-slate-900 dark:text-white mb-2">
            ¡Mensaje Enviado!
        </h3>
        <p class="text-slate-600 dark:text-slate-400">
            Gracias por contactarme. Te responderé lo antes posible.
        </p>
        <button
            id="send-another"
            class="mt-6 px-6 py-2 bg-slate-100 dark:bg-slate-700 hover:bg-slate-200 dark:hover:bg-slate-600 text-slate-700 dark:text-slate-300 rounded-lg transition-colors"
        >
            Enviar otro mensaje
        </button>
    </div>

    <div
        id="error-message"
        class="hidden mb-6 bg-red-50 dark:bg-red-900/20 border border-red-200 dark:border-red-800 text-red-700 dark:text-red-400 px-4 py-3 rounded-lg"
    >
        Hubo un error al enviar el mensaje. Por favor, intenta nuevamente.
    </div>

    <form
        id="contact-form"
        action={`https://formsubmit.co/${email}`}
        method="POST"
        class="bg-white dark:bg-slate-800 rounded-2xl p-8 border border-slate-200 dark:border-slate-700 shadow-lg text-left"
    >
        <!-- Configuración FormSubmit -->
        <input
            type="hidden"
            name="_subject"
            value="Nuevo mensaje de contacto - DevbyCes4r"
        />
        <input type="hidden" name="_template" value="table" />
        <input type="hidden" name="_captcha" value="false" />
        <input
            type="hidden"
            name="_next"
            value="https://devbyces4r.me/"
        />
        <!-- Honeypot para spam (si un bot lo llena, el email se descarta) -->
        <input type="text" name="_honey" style="display:none" />

        <div class="mb-6">
            <label
                for="name"
                class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2"
            >
                Nombre
            </label>
            <input
                type="text"
                name="name"
                id="name"
                required
                minlength="2"
                maxlength="50"
                class="w-full px-4 py-3 rounded-lg bg-slate-50 dark:bg-slate-900 border border-slate-300 dark:border-slate-600 text-slate-900 dark:text-white focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all outline-none"
                placeholder="Tu nombre"
            />
        </div>

        <div class="mb-6">
            <label
                for="email"
                class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2"
            >
                Correo Electrónico
            </label>
            <input
                type="email"
                name="email"
                id="email"
                required
                class="w-full px-4 py-3 rounded-lg bg-slate-50 dark:bg-slate-900 border border-slate-300 dark:border-slate-600 text-slate-900 dark:text-white focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all outline-none"
                placeholder="tu@email.com"
            />
        </div>

        <div class="mb-8">
            <label
                for="message"
                class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2"
            >
                Mensaje <span class="text-xs text-slate-500 font-normal"
                    >(máx. 300 caracteres)</span
                >
            </label>
            <textarea
                name="message"
                id="message"
                rows="5"
                required
                minlength="10"
                maxlength="300"
                class="w-full px-4 py-3 rounded-lg bg-slate-50 dark:bg-slate-900 border border-slate-300 dark:border-slate-600 text-slate-900 dark:text-white focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all outline-none resize-none"
                placeholder="¿En qué puedo ayudarte?"></textarea>
        </div>

        <button
            type="submit"
            class="cursor-pointer w-full py-4 bg-gradient-to-r from-blue-600 to-purple-600 hover:from-blue-500 hover:to-purple-500 text-white font-bold rounded-xl shadow-lg hover:shadow-blue-500/25 hover:-translate-y-1 transition-all duration-300 flex items-center justify-center gap-2"
        >
            <span>Enviar Mensaje</span>
            <svg
                class="w-5 h-5 rotate-90"
                fill="none"
                stroke="currentColor"
                viewBox="0 0 24 24"
            >
                <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"
                    d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"></path>
            </svg>
        </button>
    </form>
</div>

<script>
    import { trackContactSuccess, waitForGoatCounter } from '../utils/analytics';

    const form = document.getElementById("contact-form") as HTMLFormElement;
    const successMessage = document.getElementById("success-message");
    const errorMessage = document.getElementById("error-message");
    const sendAnotherBtn = document.getElementById("send-another");
    const submitBtn = form?.querySelector('button[type="submit"]');
    const submitBtnText = submitBtn?.querySelector("span");
    const submitBtnIcon = submitBtn?.querySelector("svg");

    if (form) {
        form.addEventListener("submit", async (e) => {
            e.preventDefault();

            errorMessage?.classList.add("hidden");
            if (submitBtn && submitBtnText && submitBtnIcon) {
                submitBtn.setAttribute("disabled", "true");
                submitBtnText.innerText = "Enviando...";
                submitBtnIcon.classList.add("hidden");
                submitBtn.classList.add("opacity-75", "cursor-not-allowed");
            }

            try {
                const formData = new FormData(form);
                const response = await fetch(form.action, {
                    method: "POST",
                    body: formData,
                    headers: { Accept: "application/json" },
                });

                if (response.ok) {
                    form.classList.add("hidden");
                    successMessage?.classList.remove("hidden");
                    form.reset();
                    
                    // Solo trackear envío exitoso (conversión clave)
                    waitForGoatCounter(() => trackContactSuccess());
                } else {
                    throw new Error("Error en el envío");
                }
            } catch (error) {
                errorMessage?.classList.remove("hidden");
            } finally {
                if (submitBtn && submitBtnText && submitBtnIcon) {
                    submitBtn.removeAttribute("disabled");
                    submitBtnText.innerText = "Enviar Mensaje";
                    submitBtnIcon.classList.remove("hidden");
                    submitBtn.classList.remove("opacity-75", "cursor-not-allowed");
                }
            }
        });
    }

    if (sendAnotherBtn) {
        sendAnotherBtn.addEventListener("click", () => {
            successMessage?.classList.add("hidden");
            form?.classList.remove("hidden");
        });
    }
</script>
